<html>
<head>
  <meta http-equiv="Content-type" content="text/html; charset=utf-8">
  <title>Test Websockets</title>

  <script type="text/javascript" src="jquery-1.3.2.min.js" ></script>
  <script type="text/javascript" src="jquery.objectify.js" ></script>
  <script type="text/javascript" charset="utf-8">
    var websocket;
    
    // WEBSOCKET STUFF
    $(function(){

      websocket = new WebSocket('ws://localhost:3001');
      websocket.onopen = function(){
        console.log('Connected');
      };
      websocket.onmessage = function(event){
        var coords = event.data.split(',');
        $('canvas')[0].obj.drawTo(coords[0], coords[1]);
      };
      websocket.onclose = function(){
        send('I am disconnecting');
        console.log('Disconnected');
      };
    
      $.objectify('drawingCanvas',{
        
        relativeCoords: function(event){
          return {
            x: event.pageX - this.offset.x,
            y: event.pageY - this.offset.y
          };
        },
        
        drawTo: function(x, y){
          this.context.beginPath();
          this.context.moveTo(this.current.x, this.current.y);
          this.context.lineTo(x, y);
          this.context.stroke();
          this.current.x = x;
          this.current.y = y;
          this.context.closePath();
          websocket.send([x, y]);
        },
        
        init: function(){
          var obj = this;
          this.mouse_down = false;
          this.context = this.elem.getContext('2d');
          var offset = this.jelem.offset();
          this.offset = {x: offset.left, y: offset.top};
          this.current = {x: 0, y: 0};

          this.jelem.mousedown(function(event){
            obj.mouse_down = true;
            obj.current = obj.relativeCoords(event);
          }).
          mouseup(function(){
            obj.mouse_down = false;
            // obj.current = {x: 0, y: 0};
          }).
          mousemove(function(event){
            if(obj.mouse_down){
              var relative_coords = obj.relativeCoords(event);
              obj.drawTo(relative_coords.x, relative_coords.y);
            }
          });
          
        }
      });
      
      a = $('canvas').drawingCanvas()[0].obj;

    });
    
  </script>

  <style type="text/css" media="screen">
   
    body {
      margin:0;
      text-align:center;
    }
    canvas {
      border: 1px solid #ccc;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <p>Draw you fat mumma</p>
  <canvas width="400" height="400"></canvas>
</body>
</html>
